# æ™ºèƒ½å†œä¸šè¯†åˆ«ç³»ç»Ÿ - WeChat Miniprogram

è¿™æ˜¯ä¸€ä¸ªåŸºäºå¾®ä¿¡å°ç¨‹åºçš„æ™ºèƒ½å†œä¸šç®¡ç†ç³»ç»Ÿï¼Œä½¿ç”¨AIæŠ€æœ¯è‡ªåŠ¨è¯†åˆ«å’Œæå–å†œä¸šä¿¡æ¯ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” ç”¨æˆ·ç³»ç»Ÿ
- å¾®ä¿¡æˆæƒç™»å½•
- ä¸ªäººæ•°æ®éš”ç¦»
- ç”¨æˆ·çŠ¶æ€ç®¡ç†

### ğŸ“Š æ•°æ®ç®¡ç†
- **ç”¨æˆ·è¡¨**: å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- **åœ°å—è¡¨**: ç®¡ç†ä¸åŒçš„å†œä¸šåœ°å—
- **æœå®ä¿¡æ¯è¡¨**: è®°å½•å†œä½œç‰©ç›¸å…³æ•°æ®
- **è‚¥æ–™è¡¨**: ç®¡ç†è‚¥æ–™ä½¿ç”¨ä¿¡æ¯
- **å›¾ç‰‡è¡¨**: å­˜å‚¨å’Œåˆ†æä¸Šä¼ çš„å›¾ç‰‡

### ğŸ¤– AIæ™ºèƒ½è¯†åˆ«
- æ–‡æœ¬ä¿¡æ¯æ™ºèƒ½æå–
- å›¾ç‰‡å†…å®¹è‡ªåŠ¨è¯†åˆ«
- è‚¥æ–™ä¿¡æ¯è‡ªåŠ¨è§£æ
- å†œä¸šå»ºè®®ç”Ÿæˆ

### ğŸ“± æ ¸å¿ƒé¡µé¢

#### 1. æ·»åŠ å†…å®¹é¡µé¢
- åœ°å—é€‰æ‹©å’Œç®¡ç†
- æ–‡æœ¬è¾“å…¥ï¼ˆæ”¯æŒ2000å­—ç¬¦ï¼‰
- å¤šå›¾ç‰‡ä¸Šä¼ ï¼ˆæœ€å¤š9å¼ ï¼‰
- AIå®æ—¶åˆ†æ
- ç»“æœé¢„è§ˆå’Œä¿å­˜

#### 2. æŸ¥çœ‹å†…å®¹é¡µé¢
- å†å²è®°å½•æµè§ˆ
- æœç´¢å’Œç­›é€‰åŠŸèƒ½
- å†…å®¹ç¼–è¾‘å’Œåˆ é™¤
- AIåˆ†æç»“æœå±•ç¤º

#### 3. ç»Ÿè®¡åˆ†æé¡µé¢
- æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ
- åœ°å—ä½¿ç”¨åˆ†æ
- è‚¥æ–™ä½¿ç”¨ç»Ÿè®¡
- æœ€è¿‘æ´»åŠ¨æ—¶é—´çº¿
- AIæ´å¯Ÿå»ºè®®
- æ•°æ®å¯¼å‡ºåŠŸèƒ½

## é¡¹ç›®ç»“æ„

```
miniprogram/
â”œâ”€â”€ app.json                 # å°ç¨‹åºé…ç½®
â”œâ”€â”€ app.ts                   # åº”ç”¨å…¥å£
â”œâ”€â”€ app.wxss                 # å…¨å±€æ ·å¼
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ login/              # WeChat ç™»å½•é¡µï¼ˆæ£€æµ‹æ–°ç”¨æˆ· / è€ç”¨æˆ·ï¼‰
â”‚   â”œâ”€â”€ register/           # æ–°ç”¨æˆ·æ³¨å†Œé¡µï¼ˆè¾“å…¥é‚€è¯·ç ï¼‰
â”‚   â”œâ”€â”€ add-content/        # æ·»åŠ å†…å®¹é¡µé¢
â”‚   â”œâ”€â”€ check-content/      # æŸ¥çœ‹å†…å®¹é¡µé¢
â”‚   â”œâ”€â”€ content-detail/     # è®°å½•è¯¦æƒ…é¡µé¢
â”‚   â”œâ”€â”€ content-edit/       # ç¼–è¾‘è®°å½•é¡µé¢
â”‚   â”œâ”€â”€ manage-landblocks/  # åœ°å—ç®¡ç†é¡µé¢
â”‚   â”œâ”€â”€ statistics/         # ç»Ÿè®¡é¡µé¢
â”‚   â””â”€â”€ index/              # é¦–é¡µï¼ˆé‡å®šå‘ï¼‰
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ database.ts         # æ•°æ®åº“æ¥å£
â”‚   â””â”€â”€ util.ts            # å·¥å…·å‡½æ•°
â””â”€â”€ images/                 # é™æ€å›¾ç‰‡èµ„æº
```

## å¼€å‘ç¯å¢ƒæ­å»º

### å‰ç«¯ï¼ˆå°ç¨‹åºï¼‰
1. å®‰è£…å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. å¯¼å…¥é¡¹ç›®ç›®å½•
3. é…ç½® AppID
4. ä¿®æ”¹ `utils/database.ts` ä¸­çš„ `baseUrl` ä¸ºä½ çš„åç«¯åœ°å€

### åç«¯
å‚è€ƒ `BACKEND_API.md` æ–‡æ¡£æ­å»ºåç«¯æœåŠ¡ï¼Œéœ€è¦å®ç°ï¼š
- ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- æ•°æ®åº“æ“ä½œæ¥å£
- AIåˆ†ææœåŠ¡
- æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½

## æŠ€æœ¯æ ˆ

- **å‰ç«¯**: å¾®ä¿¡å°ç¨‹åºåŸç”Ÿå¼€å‘ + TypeScript
- **åç«¯**: Node.js/Python/Javaï¼ˆä»»é€‰ï¼‰
- **æ•°æ®åº“**: MySQL/PostgreSQL
- **AIæœåŠ¡**: OpenAI GPT / è‡ªå®šä¹‰æ¨¡å‹
- **å­˜å‚¨**: äº‘å­˜å‚¨æœåŠ¡

## æ ¸å¿ƒåŠŸèƒ½æµç¨‹

### 1. ç”¨æˆ·ç™»å½•æµç¨‹
```
ç”¨æˆ·æ‰“å¼€å°ç¨‹åº â†’ æ£€æŸ¥ç™»å½•çŠ¶æ€ â†’ å¾®ä¿¡æˆæƒ â†’ è·å–ç”¨æˆ·ä¿¡æ¯ â†’ å­˜å‚¨ç™»å½•çŠ¶æ€
```

### 2. å†…å®¹æ·»åŠ æµç¨‹  
```
é€‰æ‹©åœ°å— â†’ è¾“å…¥æ–‡æœ¬/ä¸Šä¼ å›¾ç‰‡ â†’ AIåˆ†æ â†’ é¢„è§ˆç»“æœ â†’ ç¡®è®¤ä¿å­˜
```

### 3. AIåˆ†ææµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ åç«¯AIæœåŠ¡ â†’ ä¿¡æ¯æå– â†’ ç»“æ„åŒ–æ•°æ® â†’ è¿”å›å‰ç«¯å±•ç¤º
```

## é‚€è¯·ç ç®¡ç† (Invitation Codes)

åªæœ‰æŒæœ‰é‚€è¯·ç çš„ç”¨æˆ·æ‰èƒ½å®Œæˆæ³¨å†Œï¼Œå·²æ³¨å†Œçš„è€ç”¨æˆ·æ­£å¸¸ç™»å½•ä¸å—å½±å“ã€‚

### åˆå§‹åŒ–

åœ¨ Supabase SQL Editor ä¸­ä¾æ¬¡è¿è¡Œï¼š
1. `backend/db_schema.sql`ï¼ˆä¸»æ•°æ®è¡¨ï¼‰
2. `backend/invitation_codes_schema.sql`ï¼ˆé‚€è¯·ç è¡¨ + å·¥å…·å‡½æ•°ï¼‰

### ç”Ÿæˆé‚€è¯·ç ï¼ˆSQL Editor ä¸­æ‰§è¡Œï¼‰

```sql
-- ç”Ÿæˆ 5 ä¸ªéšæœºå•æ¬¡ä½¿ç”¨é‚€è¯·ç ï¼š
select * from create_invitation_codes(5, 'Initial beta users');

-- ç”Ÿæˆ 1 ä¸ªå¯ä¾› 50 äººä½¿ç”¨ã€30 å¤©åè¿‡æœŸçš„é‚€è¯·ç ï¼š
select * from create_invitation_codes(1, 'Team signup link', 50, 30);

-- åˆ›å»ºæŒ‡å®šé‚€è¯·ç ï¼š
insert into invitation_codes (code, note, max_uses)
values ('FARM2026', 'Joe personal code', 1);

-- æŸ¥çœ‹æ‰€æœ‰é‚€è¯·ç çŠ¶æ€ï¼š
select code, note, use_count, max_uses, is_active, expires_at
from invitation_codes order by created_at desc;
```

### æ³¨å†Œæµç¨‹

```
æ–°ç”¨æˆ·æ‰“å¼€å°ç¨‹åº
  â†’ ç‚¹å‡»ã€Œå¾®ä¿¡ç™»å½•ã€
  â†’ wx.login() code å‘é€åˆ° wechat-loginï¼ˆä¸å¸¦é‚€è¯·ç ï¼‰
  â†’ åç«¯æ£€æµ‹åˆ°æ–° openid â†’ è¿”å› { is_new_user: true }
  â†’ è·³è½¬åˆ°ã€Œæ³¨å†Œé¡µé¢ã€
  â†’ ç”¨æˆ·å¡«å†™é‚€è¯·ç å’Œæ˜µç§°
  â†’ ç‚¹å‡»ã€Œå®Œæˆæ³¨å†Œã€
  â†’ é‡æ–°è·å– wx.login() code + é‚€è¯·ç ä¸€èµ·å‘é€åˆ° wechat-login
  â†’ åç«¯æ ¡éªŒé‚€è¯·ç  â†’ åˆ›å»ºç”¨æˆ· â†’ æ ‡è®°é‚€è¯·ç å·²ä½¿ç”¨ â†’ è¿”å› JWT
  â†’ å­˜å‚¨ token â†’ è¿›å…¥ä¸»åº”ç”¨

è€ç”¨æˆ·æ‰“å¼€å°ç¨‹åº
  â†’ ç‚¹å‡»ã€Œå¾®ä¿¡ç™»å½•ã€â†’ ç›´æ¥è¿”å› JWT â†’ è¿›å…¥ä¸»åº”ç”¨ï¼ˆæ— éœ€é‚€è¯·ç ï¼‰
```

---

## éƒ¨ç½²è¯´æ˜

### å°ç¨‹åºå‘å¸ƒ
1. åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æ³¨å†Œå°ç¨‹åº
2. é…ç½®æœåŠ¡å™¨åŸŸåï¼ˆæ·»åŠ  `https://<project-ref>.supabase.co`ï¼‰
3. ä¸Šä¼ ä»£ç å®¡æ ¸
4. å‘å¸ƒä¸Šçº¿

### åç«¯éƒ¨ç½²ï¼ˆSupabaseï¼‰
1. æŒ‰ç…§ä¸Šæ–¹æ­¥éª¤åˆ›å»º Supabase é¡¹ç›®
2. è¿è¡Œ `db_schema.sql` å’Œ `invitation_codes_schema.sql`
3. é…ç½® Storage bucket `images`
4. éƒ¨ç½² Edge Functionsï¼š`wechat-login`ã€`analyze-text`
5. è®¾ç½® Edge Function ç¯å¢ƒå˜é‡ï¼ˆSecretsï¼‰

## ç¯å¢ƒå˜é‡é…ç½®ï¼ˆEdge Function Secretsï¼‰

åœ¨ Supabase æ§åˆ¶å° **Edge Functions â†’ Secrets** æˆ–é€šè¿‡ CLI è®¾ç½®ï¼š

```bash
supabase secrets set WECHAT_APP_ID=your_wechat_appid
supabase secrets set WECHAT_APP_SECRET=your_wechat_appsecret
supabase secrets set SUPABASE_URL=https://<project-ref>.supabase.co
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
# å¯é€‰ï¼šçœŸå® AI åˆ†æ
supabase secrets set OPENAI_API_KEY=sk-...
```

å‰ç«¯é…ç½®ï¼ˆ`miniprogram/utils/supabase/client.ts`ï¼‰ï¼š
```typescript
const SUPABASE_URL = 'https://<project-ref>.supabase.co'
const SUPABASE_ANON_KEY = 'eyJ...'  // anon å…¬å¼€å¯†é’¥ï¼Œé service_role
```

## å¼€å‘æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**
   - æ‰€æœ‰APIè¯·æ±‚éœ€è¦tokenéªŒè¯
   - ç”¨æˆ·æ•°æ®ä¸¥æ ¼éš”ç¦»
   - è¾“å…¥æ•°æ®éªŒè¯å’Œæ¸…ç†

2. **æ€§èƒ½ä¼˜åŒ–**
   - å›¾ç‰‡å‹ç¼©ä¸Šä¼ 
   - åˆ†é¡µåŠ è½½æ•°æ®
   - ç¼“å­˜å¸¸ç”¨æ•°æ®

3. **ç”¨æˆ·ä½“éªŒ**
   - åŠ è½½çŠ¶æ€æç¤º
   - é”™è¯¯å¤„ç†å’Œåé¦ˆ
   - ç¦»çº¿æ•°æ®ç¼“å­˜

## APIæ¥å£æ–‡æ¡£

è¯¦ç»†çš„APIæ¥å£æ–‡æ¡£è¯·å‚è€ƒ `BACKEND_API.md` æ–‡ä»¶ã€‚

## æ•°æ®è¡¨è®¾è®¡

### ç”¨æˆ·è¡¨ (users)
- id, openid, nickname, avatar_url, created_at, updated_at

### åœ°å—è¡¨ (land_blocks)
- id, user_id, name, description, created_at, updated_at

### æœå®ä¿¡æ¯è¡¨ (fruit_information)
- id, land_block_id, session_id, img_url, fertilizer_ids, content, extracted_data, created_at, updated_at

### è‚¥æ–™è¡¨ (fertilizers)
- id, name, amount, unit, description, created_at, updated_at

### å›¾ç‰‡è¡¨ (images)
- id, url, content, file_path, created_at

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ· Pull Request

## è®¸å¯è¯

MIT License

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»å¼€å‘è€…ã€‚